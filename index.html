<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beatbox Kids by MaestrodiMusica.com</title>
    <link href="https://fonts.googleapis.com/css2?family=Schoolbell&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        .beatbox-app {
            font-family: 'Schoolbell', cursive;
            background-color: transparent;
            padding: 20px;
            text-align: center;
            max-width: 900px;
            margin: 0 auto;
            user-select: none;
        }
        
        .beatbox-app h1 {
            color: #000;
            margin: 0 0 20px 0;
            font-size: 2.2rem;
            text-shadow: 2px 2px 0 rgba(255,198,0,0.3);
        }
        
        .beatbox-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .beatbox-palette {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            min-width: 140px;
            background-color: #f5f5f5;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .palette-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .palette-item:hover {
            background-color: rgba(255,198,0,0.2);
        }
        
        .quarter-note {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #000;
            cursor: grab;
            flex-shrink: 0;
        }
        
        .eighth-notes {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            cursor: grab;
            flex-shrink: 0;
        }
        
        .eighth-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #000;
            position: relative;
        }
        
        .eighth-dot::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: white;
            transform: translateX(-50%);
        }
        
        .note-label {
            font-size: 1rem;
            white-space: nowrap;
        }
        
        .beatbox-grid {
            display: grid;
            grid-template-columns: repeat(16, 50px);
            gap: 5px;
        }
        
        .beatbox-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .instrument-label {
            width: 80px;
            text-align: right;
            margin-right: 10px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .beatbox-cell {
            width: 50px;
            height: 50px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .beatbox-cell:hover {
            background-color: #f0f0f0;
        }
        
        .beatbox-cell.active {
            background-color: #ffc600;
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255,198,0,0.5);
        }
        
        .beat-number {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1rem;
            color: #555;
        }
        
        .beat-special {
            background-color: rgba(255, 158, 0, 0.1);
        }
        
        .beatbox-progress {
            width: 100%;
            height: 12px;
            background-color: #000;
            margin: 30px 0;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #ffc600;
            transition: width 0.1s;
        }
        
        .beatbox-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .beatbox-btn {
            background-color: #ffc600;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Schoolbell', cursive;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .beatbox-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .beatbox-btn:active {
            transform: translateY(0);
        }
        
        .bpm-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f5f5f5;
            padding: 8px 15px;
            border-radius: 30px;
        }
        
        .bpm-control label {
            font-weight: bold;
        }
        
        .bpm-control input {
            width: 60px;
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }
        
        @media (max-width: 768px) {
            .beatbox-container {
                flex-direction: column;
                align-items: center;
            }
            
            .beatbox-palette {
                width: 100%;
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .beatbox-grid {
                grid-template-columns: repeat(16, 40px);
            }
            
            .beatbox-cell {
                width: 40px;
                height: 40px;
            }
            
            .instrument-label {
                width: 70px;
                font-size: 1rem;
            }
            
            .quarter-note {
                width: 28px;
                height: 28px;
            }
            
            .eighth-dot {
                width: 16px;
                height: 16px;
            }
            
            .note-label {
                font-size: 0.9rem;
            }
            
            .beatbox-controls {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="beatbox-app">
        <h1>Beatbox Kids</h1>
        
        <div class="beatbox-container">
            <div class="beatbox-palette">
                <div class="palette-item" data-type="quarter">
                    <div class="quarter-note" draggable="true"></div>
                    <div class="note-label">Semiminima (1/4)</div>
                </div>
                <div class="palette-item" data-type="eighth">
                    <div class="eighth-notes" draggable="true">
                        <span class="eighth-dot"></span>
                        <span class="eighth-dot"></span>
                    </div>
                    <div class="note-label">Crome (1/8)</div>
                </div>
            </div>
            
            <div class="beatbox-grid-container">
                <div class="beatbox-row">
                    <div class="instrument-label">Kick</div>
                    <div class="beatbox-grid" data-inst="0"></div>
                </div>
                <div class="beatbox-row">
                    <div class="instrument-label">Snare</div>
                    <div class="beatbox-grid" data-inst="1"></div>
                </div>
                <div class="beatbox-row">
                    <div class="instrument-label">Hi-hat</div>
                    <div class="beatbox-grid" data-inst="2"></div>
                </div>
            </div>
        </div>
        
        <div class="beatbox-progress">
            <div class="progress-bar"></div>
        </div>
        
        <div class="beatbox-controls">
            <button class="beatbox-btn" id="playBtn">‚ñ∂Ô∏è Play</button>
            <div class="bpm-control">
                <label for="bpm">BPM:</label>
                <input type="number" id="bpm" value="120" min="60" max="200">
            </div>
            <button class="beatbox-btn" id="clearBtn">üóëÔ∏è Cancella</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configurazione audio
            const instruments = ['kick', 'snare', 'hihat'];
            const audioFiles = {
                'kick': 'https://maestrodimusicalab.github.io/beatbox-kids/sounds/kick.mp3',
                'snare': 'https://maestrodimusicalab.github.io/beatbox-kids/sounds/snare.mp3',
                'hihat': 'https://maestrodimusicalab.github.io/beatbox-kids/sounds/hihat.mp3'
            };
            
            // Inizializza Tone.js
            const players = new Tone.Players({
                urls: audioFiles,
                onload: function() {
                    console.log('Audio caricato');
                },
                onerror: function(error) {
                    console.error('Errore caricamento audio:', error);
                }
            }).toDestination();
            
            // Stato dell'app
            const gridState = Array(3).fill().map(() => Array(16).fill(null));
            let isPlaying = false;
            let currentStep = 0;
            
            // Inizializzazione griglia
            function initializeGrid() {
                document.querySelectorAll('.beatbox-grid').forEach((grid, rowIdx) => {
                    grid.innerHTML = '';
                    
                    for (let colIdx = 0; colIdx < 16; colIdx++) {
                        const cell = document.createElement('div');
                        cell.className = 'beatbox-cell';
                        cell.dataset.row = rowIdx;
                        cell.dataset.col = colIdx;
                        
                        if (rowIdx === 0) {
                            const number = document.createElement('div');
                            number.className = 'beat-number';
                            number.textContent = (colIdx % 4) + 1;
                            cell.appendChild(number);
                        }
                        
                        if ([0, 4, 8, 12].includes(colIdx)) {
                            cell.classList.add('beat-special');
                        }
                        
                        // Aggiungi eventi
                        cell.addEventListener('click', handleCellClick);
                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('dragleave', handleDragLeave);
                        cell.addEventListener('drop', handleDrop);
                        
                        grid.appendChild(cell);
                    }
                });
            }
            
            // Inizializza elementi trascinabili
            function initializeDraggables() {
                document.querySelectorAll('.palette-item').forEach(item => {
                    const noteType = item.dataset.type;
                    const draggableElement = item.querySelector('[draggable="true"]');
                    
                    draggableElement.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('noteType', noteType);
                        this.style.opacity = '0.5';
                    });
                    
                    draggableElement.addEventListener('dragend', function() {
                        this.style.opacity = '1';
                    });
                    
                    // Aggiungi click per mobile
                    item.addEventListener('click', function() {
                        const noteType = this.dataset.type;
                        document.activeNoteType = noteType;
                        document.querySelectorAll('.beatbox-cell').forEach(cell => {
                            cell.classList.add('note-ready');
                        });
                    });
                });
            }
            
            // Gestione eventi
            function handleCellClick(e) {
                if (document.activeNoteType) {
                    addNoteToCell(this, document.activeNoteType);
                } else if (e.detail === 2) { // Doppio click
                    clearCell(this);
                }
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                this.style.transform = 'scale(1.05)';
            }
            
            function handleDragLeave() {
                this.style.transform = '';
            }
            
            function handleDrop(e) {
                e.preventDefault();
                this.style.transform = '';
                const noteType = e.dataTransfer.getData('noteType');
                addNoteToCell(this, noteType);
            }
            
            // Funzioni principali
            function addNoteToCell(cell, noteType) {
                const rowIdx = parseInt(cell.dataset.row);
                const colIdx = parseInt(cell.dataset.col);
                
                // Pulisci la cella
                cell.innerHTML = '';
                
                // Aggiungi numero di beat se prima riga
                if (rowIdx === 0) {
                    const number = document.createElement('div');
                    number.className = 'beat-number';
                    number.textContent = (colIdx % 4) + 1;
                    cell.appendChild(number);
                }
                
                // Aggiungi nota
                if (noteType === 'quarter') {
                    const note = document.createElement('div');
                    note.className = 'quarter-note';
                    cell.appendChild(note);
                } else if (noteType === 'eighth') {
                    const notes = document.createElement('div');
                    notes.className = 'eighth-notes';
                    notes.innerHTML = '<span class="eighth-dot"></span><span class="eighth-dot"></span>';
                    cell.appendChild(notes);
                }
                
                // Aggiorna stato
                gridState[rowIdx][colIdx] = noteType;
                
                // Feedback visivo
                cell.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    cell.style.transform = '';
                }, 200);
            }
            
            function clearCell(cell) {
                const rowIdx = parseInt(cell.dataset.row);
                const colIdx = parseInt(cell.dataset.col);
                
                // Pulisci la cella
                cell.innerHTML = '';
                
                // Aggiungi numero di beat se prima riga
                if (rowIdx === 0) {
                    const number = document.createElement('div');
                    number.className = 'beat-number';
                    number.textContent = (colIdx % 4) + 1;
                    cell.appendChild(number);
                }
                
                // Aggiorna stato
                gridState[rowIdx][colIdx] = null;
                
                // Feedback visivo
                cell.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    cell.style.transform = '';
                }, 200);
            }
            
            function updateUI() {
                document.querySelector('.progress-bar').style.width = `${(currentStep / 16) * 100}%`;
                
                document.querySelectorAll('.beatbox-cell').forEach(cell => {
                    cell.classList.remove('active');
                    if (parseInt(cell.dataset.col) === currentStep) {
                        cell.classList.add('active');
                    }
                });
            }
            
            // Sequencer
            const sequencer = new Tone.Loop(function(time) {
                gridState.forEach((row, rowIdx) => {
                    const noteType = row[currentStep];
                    if (noteType === 'quarter') {
                        players.player(instruments[rowIdx]).start(time);
                    } else if (noteType === 'eighth') {
                        players.player(instruments[rowIdx]).start(time);
                        players.player(instruments[rowIdx]).start(time + Tone.Time('8n').toSeconds());
                    }
                });
                
                updateUI();
                currentStep = (currentStep + 1) % 16;
            }, '4n');
            
            // Controlli
            const playBtn = document.getElementById('playBtn');
            const bpmInput = document.getElementById('bpm');
            const clearBtn = document.getElementById('clearBtn');
            
            playBtn.addEventListener('click', togglePlayback);
            bpmInput.addEventListener('change', updateBPM);
            clearBtn.addEventListener('click', clearAll);
            
            // Funzioni controllo
            function togglePlayback() {
                if (!isPlaying) {
                    Tone.start().then(function() {
                        Tone.Transport.bpm.value = bpmInput.value;
                        sequencer.start(0);
                        Tone.Transport.start();
                        playBtn.textContent = '‚è∏Ô∏è Stop';
                        isPlaying = true;
                    }).catch(function(err) {
                        console.error('Audio error:', err);
                        alert('Errore nell\'inizializzazione audio. Ricarica la pagina e riprova.');
                    });
                } else {
                    sequencer.stop();
                    Tone.Transport.stop();
                    playBtn.textContent = '‚ñ∂Ô∏è Play';
                    isPlaying = false;
                    currentStep = 0;
                    updateUI();
                }
            }
            
            function updateBPM() {
                const bpm = Math.min(Math.max(parseInt(this.value), 60), 200);
                this.value = bpm;
                if (!isNaN(bpm)) {
                    Tone.Transport.bpm.value = bpm;
                }
            }
            
            function clearAll() {
                if (confirm('Cancellare tutta la griglia?')) {
                    // Resetta lo stato
                    for (let i = 0; i < gridState.length; i++) {
                        gridState[i] = Array(16).fill(null);
                    }
                    
                    // Pulisci tutte le celle
                    document.querySelectorAll('.beatbox-cell').forEach(function(cell) {
                        const rowIdx = parseInt(cell.dataset.row);
                        const colIdx = parseInt(cell.dataset.col);
                        cell.innerHTML = '';
                        
                        if (rowIdx === 0) {
                            const number = document.createElement('div');
                            number.className = 'beat-number';
                            number.textContent = (colIdx % 4) + 1;
                            cell.appendChild(number);
                        }
                    });
                }
            }
            
            // Inizializza l'app
            initializeGrid();
            initializeDraggables();
            
            // Resetta lo stato attivo quando si clicca fuori
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.palette-item') && !e.target.closest('.beatbox-cell')) {
                    delete document.activeNoteType;
                    document.querySelectorAll('.beatbox-cell').forEach(cell => {
                        cell.classList.remove('note-ready');
                    });
                }
            });
        });
    </script>
</body>
</html>
